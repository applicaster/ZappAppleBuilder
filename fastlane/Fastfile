require 'spaceship'
require "json"

import "FaslaneUpload.rb"
import "FastfileTest"
import "BuildTypeFactory.rb"
import "Enterprise/Types/Client/Client.rb"
import "Enterprise/Types/Debug/Debug.rb"
import "Store/Store.rb"

platform :ios do
    before_all do
        set_device_family
        install_awscli_if_needed
        create_temp_keychain
    end

    lane :prepare_environment do
        BuildTypeFactory.new.prepare_environment
    end

    lane :validate_app_signing do
        BuildTypeFactory.new.perform_signing_validation
        BuildTypeFactory.new.prepare_environment
    end

    lane :build do
        BuildTypeFactory.new.build
    end
end

def create_temp_keychain
    create_keychain(
        name:  keychain_name,
        password: keychain_password,
        unlock: true,
        timeout: false
     )
end

def set_device_family
    puts("Setting device family param")
  
    device_family = ENV["device_target"]
    ENV["DEVICE_FAMILY"] = "1,2"
    if device_family == "iphone"
        ENV["DEVICE_FAMILY"] = "1"
    end
    if device_family == "ipad"
        ENV["DEVICE_FAMILY"] = "2"
    end
  end
  
def install_awscli_if_needed
    envHelper = EnvironmentHelper.new
    unless envHelper.bundle_identifier.to_s.strip.empty?          
        if envHelper.isTvOS
            puts("Installing S3 AWS")
            sh("sudo pip install awscli")
        end
    end
end

def save_param_to_file(name, value)
    folder_name = "#{ENV['PWD']}/.fastlane_params"
    filename = "#{folder_name}/#{name}"
    Dir.mkdir(folder_name) unless File.exists?(folder_name)
    File.open(filename,"w") do |f|
       f.write(value)
    end
end

def keychain_name
    "zapp-apple-build.keychain"
end

def keychain_password
    "circle"
end